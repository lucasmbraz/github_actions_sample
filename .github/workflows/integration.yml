name: Integration tests

on:
  issue_comment:
    types:
      - created

jobs:
  integration_tests:
    name: Merge PR
    if: ${{ contains(github.event.comment.body, 'ðŸš¢') }}
    runs-on: ubuntu-latest
    steps:
      - name: Set env
        run: echo "PR_NUMBER=$(basename ${{ github.event.comment.issue_url }})" >> $GITHUB_ENV

      - name: Comment merge is starting
        uses: hasura/comment-progress@v2.1.0
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}
          number: ${{ env.PR_NUMBER }}
          id: merge-progress
          message: 'Merge in progress :shipit:'
          append: true

      - name: Merge
        id: merge-step
        uses: nbrugger-tgm/merge-pr-action@v0.2.2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          method: squash
          pull_request: ${{ env.PR_NUMBER }}


      - name: Print merge result
        run: echo ${{ steps.merge-step.outputs.commit }}

#      - name: Merge
#        uses: Matticusau/pr-helper@v1.2.4
#        with:
#          repo-token: ${{ secrets.GITHUB_TOKEN }}
#          enable-prmerge-automation: true

#      - name: Determine Merge Result
#        uses: haya14busa/action-cond@v1
#        id: merge-result
#        with:
#          cond: ${{ steps.merge-step.outputs.commit != "" }}
#          if_true: 'Merge worked! :rocket:'
#          if_false: 'Merge failed :boom:'

      - name: Comment merge success
        if: ${{ steps.merge-step.outputs.commit != '' }}
        uses: hasura/comment-progress@v2.1.0
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}
          number: ${{ env.PR_NUMBER }}
          id: merge-progress
          message: 'Merge worked! :rocket:'
          append: true

      - name: Comment merge failure
        if: ${{ steps.merge-step.outputs.commit == '' }}
        uses: hasura/comment-progress@v2.1.0
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          repository: ${{ github.repository }}
          number: ${{ env.PR_NUMBER }}
          id: merge-progress
          message: 'Merge failed! :boom:'
          append: true